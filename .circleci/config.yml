version: 2.1

base_defaults: &base_defaults
    resource_class: xlarge
    working_directory: /home/chronon/workspace

executors:
    docker_baseimg_executor:
        resource_class: xlarge
        working_directory: /home/chronon/workspace
        docker:
            - image: krisnaru/chronon:krish-test-6

jobs:
    "Pull Docker Image":
        <<: *base_defaults
        docker:
            - image: docker:17.05.0-ce-git
        steps:
            - setup_remote_docker:
                docker_layer_caching: true
            - checkout
            - run:
                name: Pull existing docker image
                command: |
                    set +o pipefail
                    docker pull krisnaru/chronon:krish-test-6 || true

    "Scala 12 -- Spark 3 Tests":
        executor: docker_baseimg_executor
        steps:
            - checkout
            - run:
                  name: Run Spark 3.1.1 tests
                  shell: /bin/bash -leuxo pipefail
                  command: |
                      bazel test --config scala_2.12 --config spark_3.1 //spark:test

    "Scala 13 -- Tests":
        executor: docker_baseimg_executor
        steps:
            - checkout
            - run:
                  name: Run Scala 13 tests
                  shell: /bin/bash -leuxo pipefail
                  command: |
                      bazel test --config scala_2.13 --config spark_3.2 //spark:test

    # run these separately as we need a isolated JVM to not have Spark session settings interfere with other runs
    # long term goal is to refactor the current testing spark session builder and avoid adding new single test to CI
    "Scala 13 -- Delta Lake Format Tests":
      executor: docker_baseimg_executor
      steps:
        - checkout
        - run:
            name: Run Scala 13 tests for Delta Lake format
            environment:
              format_test: deltalake
            shell: /bin/bash -leuxo pipefail
            command: |
              bazel test --config scala_2.13 --config spark_3.1 //spark:TableUtilsFormatTest

#    "Chronon Python Lint":
#        executor: docker_baseimg_executor
#        steps:
#            - checkout
#            - run:
#                  name: Run Chronon Python lint
#                  shell: /bin/bash -leuxo pipefail
#                  command: |
#                      conda activate chronon_py
#                      cd /chronon/api/py/ai/chronon
#                      pip install importlib-metadata==4.11.4 #Install importlib-metadata < 5
#                      flake8 --extend-ignore=W605,Q000,F631,E203

    "Chronon Python Tests":
        executor: docker_baseimg_executor
        steps:
            - checkout
            - run:
                  name: Run Chronon Python tests
                  shell: /bin/bash -leuxo pipefail
                  command: |
                    bazel test //api/py:api_test


#    "Scalafmt Check":
#        executor: docker_baseimg_executor
#        steps:
#            - checkout
#            - run:
#                  name: Run ScalafmtCheck
#                  shell: /bin/bash -leuxo pipefail
#                  command: |
#                      conda activate chronon_py
#                      sbt +scalafmtCheck

workflows:
    build_test_deploy:
        jobs:
            - "Pull Docker Image"
            - "Scala 12 -- Spark 3 Tests":
                  requires:
                      - "Pull Docker Image"
            - "Scala 13 -- Tests":
                  requires:
                      - "Pull Docker Image"
            - "Scala 13 -- Delta Lake Format Tests":
                  requires:
                    - "Pull Docker Image"
#            - "Scalafmt Check":
#                  requires:
#                      - "Pull Docker Image"
            - "Chronon Python Tests":
                  requires:
                      - "Pull Docker Image"
#            - "Chronon Python Lint":
#                  requires:
#                      - "Pull Docker Image"
