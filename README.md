# Stripe Chronon Setup Instructions

_These docs are very WIP. Please don't hesitate to make PRs with changes
to the instructions, or to get in touch with us in #ml-features-shepherd on Slack!_

## Step 1: Install Docker
You can install from Managed Software Center. 

## Step 2: Build an image from `LocalDockerFile`

In the `chronon/` directory, run `docker build --progress=plain -f LocalDockerfile .` This should take about 10-15 minutes on a M1 Max Macbook Pro.

(The LocalDockerfile uses an arm64 base image and downloads arm64 deps- if you're still on an Intel laptop you may need to change the architecture of the base image and the miniconda install).

Then, run `docker images`, and you should see a new image:

```
st-andrewlee2:chronon andrewlee$ docker images
REPOSITORY                                                   TAG            IMAGE ID       CREATED       SIZE
<none>                                                       <none>         9538e5c15751   2 hours ago   1.22GB
```

Grab the image ID (`9538e5c15751` in my case) and tag it with something easy to remember, like:

`docker tag 9538e5c15751 chrononlocal:latest`

(In the future we'll get a prebuilt container image into [Stripe's container registry](https://amp.corp.stripe.com/containers/northwest)
so folks won't have to go through this step)

## Step 3: Starting the image, initial setup + compile

Run the image with `docker run -v ~/stripe/chronon/:/chronon -it chrononlocal:latest bash`.

This will mount the `chronon/` directory on your laptop at `/chronon` in the image, so the container
will run with changes to the codebase from your local text editor / IDE.


### Generating Thrift Java classes
Run the following commands:
```
mkdir -p /chronon/api/target/scala-2.12/src_managed/main
thrift --gen java -out /chronon/api/target/scala-2.12/src_managed/main api/thrift/api.thrift
```
You should see newly-autogenerated classes under `api/target/scala-2.12/src_managed/main` locally now.

### Compiling and testing Scala
Run `sbt "++ 2.12.12 compile"`. (Scala 2.12.12 is preinstalled on the container, without it `sbt` will try to 
download a different Scala version) 

Compiling took about a minute on an M1 Max Macbook Pro.

Run `sbt "++ 2.12.12 test"`. This took about 10-15 minutes on an M1 Max Macbook Pro, the lion's share of which is spent running Spark tests. We recommend running all the tests once to ensure all dependencies are properly configured. During development, you can specify a particular test to run in `sbt` as instructed here: https://git.corp.stripe.com/stripe-private-oss-forks/chronon/blob/master/devnotes.md#L63

### Setting up and testing Python

Run the following setup script, which will generate Python code for thrifts and 
install Python packages for tests:
```
bash /py_container_setup.sh  
```

To run the Python tests, run `tox` from `/chronon/api/py`.
