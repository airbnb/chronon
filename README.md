# Stripe Chronon Setup Instructions

_These docs are very WIP. Please don't hesitate to make PRs with changes
to the instructions, or to get in touch with us in #ml-features-shepherd on Slack!_

## Step 1: Install Docker
You can install from Managed Software Center. 

## Step 2: Build an image from `LocalDockerFile`

In the `chronon/` directory, run `docker build --progress=plain -f LocalDockerfile .` This took me about 15 minutes.

Then, run `docker images`, and you should see a new image:

```
st-andrewlee2:chronon andrewlee$ docker images
REPOSITORY                                                   TAG            IMAGE ID       CREATED       SIZE
<none>                                                       <none>         9538e5c15751   2 hours ago   1.22GB
```

Grab the image ID (`9538e5c15751` in my case) and tag it with something easy to remember, like:

`docker tag 9538e5c15751 chrononlocal:latest`

(In the future we'll get a prebuilt container image into [Stripe's container registry](https://amp.corp.stripe.com/containers/northwest)
so folks won't have to go through this step)

## Step 3: Starting the image, initial setup + compile

Run the image with `docker run -v ~/stripe/chronon/:/chronon -v ~/.sbt:/root/.sbt -v ~/.ivy2:/root/.ivy2 -it chrononlocal:latest bash`.

This will mount the `chronon/` directory on your laptop at `/chronon` in the image, so the container
will run with changes to the codebase from your local text editor / IDE

(This also mounts two local directories that are supposed to help accelerate `sbt` startup,
although I'm not sure if they're truly necessary)

### Generating Thrift Java classes
`cd` into `/chronon` and run the following commands:
```
root@793ed7fcefb2:/chronon# mkdir -p api/target/scala-2.12/src_managed/main
root@793ed7fcefb2:/chronon# thrift --gen java -out api/target/scala-2.12/src_managed/main api/thrift/api.thrift
```
You should see newly-autogenerated classes under `api/target/scala-2.12/src_managed/main` locally now.

### Compiling and testing Scala
Run `sbt "++ 2.12.12 compile"`. (Scala 2.12.12 is preinstalled on the container, without it `sbt` will try to 
download a different Scala version) 

Compiling went relatively quickly for me (1-2 minutes?).

Run `sbt "++ 2.12.12 test"`. This took me about 10 minutes.

### Setting up and testing Python

Run the following setup script, which will generate Python code for thrifts and 
install Python packages for tests:
```
bash /py_container_setup.sh  
```

To run the Python tests, run `tox` from `/chronon/api/py`.
